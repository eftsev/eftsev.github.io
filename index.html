<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Web App</title>
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-control-geocoder.Geocoder.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        /* Move the Basemaps header up and use vw for spacing */
        .leaflet-control-layers-expanded {
            padding-top: 0vw !important;
            padding-right: 1vw !important;
            padding-bottom: 0.5vw !important;
        }
        .custom-basemap-header {
            font-weight: bold;
            color: rgb(0, 0, 0);
            margin: -1.27vw 0 0.5vw 0 !important;
            font-size: 0.5vw;
        }
/* Popup box styling - same as index - Copy, but no width/height */
.leaflet-popup {
    background: #ffffff; /* White background */
    border: 1px solid #ccc; /* Light gray border */
    border-radius: 10px; /* Rounded corners */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Subtle shadow */
    font-family: 'Arial', sans-serif; /* Modern font */
    color: #333; /* Text color */
}

.leaflet-popup-content-wrapper {
    border-radius: 10px;
}

.leaflet-popup-content {
    padding: 15px; /* Add padding inside the popup */
    font-size: 14px; /* Adjust font size */
    line-height: 1.5; /* Improve readability */
    /* No width or max-width here */
}

/* Popup close button */
.leaflet-popup-close-button {
    color: #333;
    font-size: 18px;
    font-weight: bold;
    text-shadow: none;
    opacity: 0.8;
}
.leaflet-popup-close-button:hover {
    color: #007bff;
    opacity: 1;
}

/* Table styling inside popup */
.leaflet-popup-content table {
    width: 100%;
    border-collapse: collapse;
}
.leaflet-popup-content th,
.leaflet-popup-content td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    vertical-align: top;
}
.leaflet-popup-content th {
    font-weight: bold;
    color: #555;
}
.leaflet-popup-content img {
    max-width: 100%;
    border-radius: 5px;
    margin-top: 10px;
}
/* ...existing code... */
.overlay {
    display: flex;
    position: fixed;
    top: 50%;
    left: 50%;
    width: 1100px;
    height: 650px;
    max-width: 98vw;
    max-height: 95vh;
    overflow: hidden;
    transform: translate(-50%, -50%) scale(0.92);
    background: rgba(255, 255, 255, 0.97);
    padding: 30px 30px 20px 30px;
    border-radius: 18px;
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.28);
    z-index: 10000;
    text-align: center;
    opacity: 0;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1), transform 0.5s cubic-bezier(.4,2,.6,1);
    display: flex;
    flex-direction: row;
    align-items: stretch; /* Stretch children vertically */
    justify-content: stretch; /* Stretch children horizontally */
}

.overlay > div {
    flex: 1 1 0;
    display: flex;
    flex-direction: row;
    height: 100%;
    min-width: 0;
    min-height: 0;
}


.overlay.open {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

.blur-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    backdrop-filter: blur(10px);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1);
}

.close-button {
    position: absolute;
    top: 14px;
    right: 22px;
    font-size: 28px;
    cursor: pointer;
    font-weight: bold;
    color: #333;
    transition: color 0.3s ease;
    z-index: 10;
}
.close-button:hover {
    color: #007bff;
}


.modern-3d-button {
    background: linear-gradient(90deg, #007bff 60%, #0056b3 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 18px;
    font-size: 15px;
    font-family: inherit;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
    margin-top: 12px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.modern-3d-button:hover, .modern-3d-button:focus {
    background: linear-gradient(90deg, #0056b3 60%, #007bff 100%);
    box-shadow: 0 4px 16px rgba(0,123,255,0.15);
    transform: translateY(-2px) scale(1.04);
    outline: none;
}

audio::-webkit-media-controls-panel {
    background-color: transparent !important; /* Make the background transparent */
    border: none !important; /* Remove any borders */
}

audio::-webkit-media-controls-enclosure {
    background-color: transparent !important; /* Make the enclosure transparent */
    border: none !important; /* Remove any borders */
}


audio {
    background-color: transparent !important; /* Ensure the audio element itself is transparent */
    border: none !important; /* Remove any borders */
    outline: none !important; /* Remove focus outline */
}

/* Invert the entire player for a dark theme */
.audio-player-inverted {
    filter: invert(1); /* Invert all colors */
}

/* Add to your <style> section */
.vertical-tabs {
    display: flex;
    flex: 0 0 130px; /* Fixed width for tabs */
    height: 100%;
    align-items: stretch;
    justify-content: stretch;
    flex-direction: column;
    min-width: 130px;
    margin-right: 24px;
    height: 100%;
    justify-content: stretch;
    align-items: stretch;
    flex: 0 0 130px;
    background: #f7f8fa;
    border-radius: 12px 0 0 12px;
    padding: 6px 0;
    gap: 4px;
    box-shadow: none;
    border-right: 1px solid #ececec;
}
.tab-btn {
    background: none;
    border: none;
    outline: none;
    padding: 16px 14px;
    text-align: left;
    font-size: 1.08em;
    cursor: pointer;
    color: #222;
    transition: 
        background 0.16s cubic-bezier(.4,2,.6,1),
        color 0.16s cubic-bezier(.4,2,.6,1),
        transform 0.16s cubic-bezier(.4,2,.6,1);
    flex: 1 1 0;
    border-radius: 8px 16px 16px 8px;
    width: 100%;
    margin: 0;
    font-weight: 500;
    letter-spacing: 0.01em;
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    background: none;
    box-shadow: none;
}
.tab-btn.active, .tab-btn:focus {
    background: #2563eb12;
    color: #2563eb;
    font-weight: 700; /* Make selected tab bold */
}
.tab-btn:hover:not(.active) {
    background: #e7eafc;
    color: #2563eb;
    font-weight: 700; /* Keep font bold on hover for consistency */
    /* Removed transform: scale(1.01) to prevent flicker */
}
.tab-btn::before {
    content: '';
    display: block;
    width: 3px;
    height: 60%;
    background: #2563eb;
    border-radius: 2px;
    position: absolute;
    left: 0;
    top: 20%;
    opacity: 0;
    transition: opacity 0.2s;
}
.tab-btn.active::before {
    opacity: 1;
}

.tab-content.active {
    display: flex;
}


/* Center and scale each tab content */
.tab-content {
    display: none;
    width: 100%;
    height: 100%;
    min-width: 0;
    min-height: 0;
    flex: 1 1 0;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
    animation: fadeInTab 0.28s cubic-bezier(.4,2,.6,1);
}
@keyframes fadeInTab {
    from { opacity: 0; transform: translateY(10px);}
    to { opacity: 1; transform: none;}
}
.tab-content:not(:first-child) {
    display: none;
}

/* Carousel Overlay Styling */
#carousel-overlay {
    display: none;
    position: fixed;
    z-index: 20000;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1);
    opacity: 0;
}
#carousel-overlay.open {
    display: flex;
    opacity: 1;
}
.carousel-container {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.28);
    width: 1100px;
    height: 650px;
    max-width: 98vw;
    max-height: 95vh;
    padding: 30px 30px 20px 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    text-align: center;
    overflow: hidden;
    transition: transform 0.5s cubic-bezier(.4,2,.6,1), opacity 0.5s cubic-bezier(.4,2,.6,1);
    transform: scale(0.92);
    opacity: 0;
}
#carousel-overlay.open .carousel-container {
    transform: scale(1);
    opacity: 1;
}
.carousel-slide {
    width: 100%;
    min-height: 180px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    left: 0; top: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.45s cubic-bezier(.4,2,.6,1), transform 0.45s cubic-bezier(.4,2,.6,1);
    transform: translateX(60px);
}
.carousel-slide.active {
    opacity: 1;
    pointer-events: auto;
    position: relative;
    transform: translateX(0);
    z-index: 2;
}
.carousel-slide.slide-out-left {
    opacity: 0;
    transform: translateX(-60px);
    z-index: 1;
}
.carousel-slide.slide-out-right {
    opacity: 0;
    transform: translateX(60px);
    z-index: 1;
}
#carousel-slides {
    position: relative;
    width: 100%;
    height: 90%;
    margin-bottom: 0;
    overflow: hidden;
}

/* Add to your <style> section, after .carousel-slide.slide-out-right */
.carousel-slide.slide-in-right {
    opacity: 1;
    transform: translateX(60px);
    animation: slideInRight 0.45s cubic-bezier(.4,2,.6,1) forwards;
    z-index: 2;
}
.carousel-slide.slide-in-left {
    opacity: 1;
    transform: translateX(-60px);
    animation: slideInLeft 0.45s cubic-bezier(.4,2,.6,1) forwards;
    z-index: 2;
}
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(60px);}
    to   { opacity: 1; transform: translateX(0);}
}
@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-60px);}
    to   { opacity: 1; transform: translateX(0);}
}
/* Add to your <style> section */
.modern-3d-button:disabled,
.modern-3d-button[disabled] {
    background: #bfc7d1 !important;
    color: #fff !important;
    cursor: default !important;
    box-shadow: none !important;
    opacity: 0.7;
    border: none;
    transform: none !important;
}

.carousel-slide h2 {
    font-size: 2.2em;
    color: #2563eb;
    text-align: center;
    margin-bottom: 30px;
    font-family: 'Arial', sans-serif;
}
.carousel-slide p {
    font-size: 1.18em;
    text-align: justify;
    font-family: 'Arial', sans-serif;
    color: #222;
    margin: 0 auto;
    max-width: 900px;
}

/* Add to your <style> section */
.carousel-container {
    position: relative; /* Ensure children can be absolutely positioned */
}

.carousel-controls-row {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 60px;
    display: flex;
    justify-content: center;
    gap: 16px;
    z-index: 10;
    font-family: 'Arial', sans-serif !important;
    font-size: 1.08em;
}

#carousel-dots {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 30px;
    display: flex;
    justify-content: center;
    gap: 8px;
    z-index: 10;
}

#carousel-checkbox-row {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 120px;
    display: none;
    align-items: center;
    justify-content: center;
    gap: 10px;
    z-index: 10;
    font-family: 'Arial', sans-serif !important;
    font-size: 1.08em;
}

/* Smooth transition for completion overlay */
#form-redirect-overlay {
    display: none;
    position: fixed;
    z-index: 20001;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.5s cubic-bezier(.4,2,.6,1);
    font-family: Arial, sans-serif !important;
}
#form-redirect-overlay.open {
    display: flex;
    opacity: 1;
}
#form-redirect-overlay .modern-3d-button {
    font-family: Arial, sans-serif !important;
}
#form-redirect-overlay h2,
#form-redirect-overlay p {
    font-family: Arial, sans-serif !important;
}

#carousel-next, #carousel-prev {
    text-align: center !important;
    justify-content: center !important;
    align-items: center !important;
    display: flex !important;
}

#carousel-slides #user-code-input {
    margin-top: 20px !important;
}

.sketchfab-embed-wrapper {
  width: 100%;
  height: 100%;
  min-height: 0;
  min-width: 0;
  display: flex;
  border-radius: 8px;
  overflow: hidden;
}
.sketchfab-embed-wrapper iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}



        </style>
        <title></title>
    </head>
    <body>
        
    <!-- Welcome Screen -->
<div id="welcome-screen" style="
    position: fixed;
    font-family: sans-serif;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;">
    <h1 style="font-size: 2em; margin-bottom: 20px;">Welcome!</h1>
    <p style="font-size: 1.2em; margin-bottom: 30px; text-align: center;">Demo Application for Master's Thesis</p>
    <button id="welcome-button" style="
        padding: 10px 20px;
        font-size: 1em;
        background-color: #007bff;
        color: white;
        font-family: sans-serif;
        border: none;
        border-radius: 5px;
        cursor: pointer;">
        Begin
    </button>
</div>

<!-- Overlay HTML -->
<div id="monument-overlay" class="overlay" style="display:none;">
    <span class="close-button" onclick="closeMonumentOverlay()">&times;</span>
    <div style="display: flex; flex: 1 1 0; min-height: 0; height: 100%;">
<!-- Vertical Tabs -->
<div class="vertical-tabs">
    <button class="tab-btn active" data-tab="info">Info</button>
    <button class="tab-btn" data-tab="desc">Description</button>
    <button class="tab-btn" data-tab="img">Image</button>
    <button class="tab-btn" data-tab="audio">Audio</button>
    <button class="tab-btn" data-tab="video">Video</button> <!-- 🟢 Add this line -->
    <button class="tab-btn" data-tab="model">3D Model</button>
    <button class="tab-btn" data-tab="qr">QR Code</button>
</div>
<!-- Tab Content -->
    <div class="tab-content" id="tab-info"></div>
    <div class="tab-content" id="tab-desc" style="display:none;"></div>
    <div class="tab-content" id="tab-img" style="display:none;"></div>
    <div class="tab-content" id="tab-audio" style="display:none;"></div>
    <div class="tab-content" id="tab-video" style="display:none;"></div> <!-- 🟢 Add this line -->
    <div class="tab-content" id="tab-model" style="display:none;"></div>
    <div class="tab-content" id="tab-qr" style="display:none;"></div>
</div>
    </div>
</div>

<!-- 1. Add EmailJS SDK in <head> -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    (function(){
        emailjs.init("m-3bZ_uYvA5aIAGtc"); // Replace with your EmailJS user ID
    })();
</script>

<div id="form-redirect-overlay">
    <div style="
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 12px 40px rgba(0,0,0,0.28);
        padding: 40px 60px;
        text-align: center;
        max-width: 90vw;
        font-family: Arial, sans-serif;
    ">
        <h2 style="color:#2563eb;">Congratulations!</h2>
        <p style="font-size:1.2em; color:#222; margin-bottom: 30px;">
            You have successfully completed all tasks.<br>
            Please click the button below to proceed to the questionnaire.
        </p>
        <button id="open-form-btn" class="modern-3d-button" style="font-size:1.1em; padding: 12px 32px;">
            Proceed to Questionnaire
        </button>
    </div>
</div>

<!-- Carousel Overlay (hidden by default) -->
<div id="carousel-overlay">
    <div class="carousel-container">
        <div id="carousel-slides"></div>
        <div id="carousel-checkbox-row">
            <input type="checkbox" id="carousel-agree-checkbox" style="transform: scale(1.3);" />
            <label for="carousel-agree-checkbox" style="font-size: 1.08em; color: #222; cursor: pointer;">
                I have read and understood the application's usage instructions.
            </label>
        </div>
        <div class="carousel-controls-row">
            <button id="carousel-prev" class="modern-3d-button" style="min-width:80px;">Previous</button>
            <button id="carousel-next" class="modern-3d-button" style="min-width:80px;">Next</button>
        </div>
        <div id="carousel-dots"></div>
    </div>
</div>

<div id="task-counter" style="
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    z-index: 30000;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.13);
    padding: 14px 32px;
    font-family: Arial, sans-serif;
    font-size: 1.18em;
    color: #c0392b;
    font-weight: 600;
    border: 2px solid #c0392b;
    display: none;
    transition: color 0.3s, border-color 0.3s, background 0.3s;
"></div>

<!-- Blurred Background -->
<div id="blur-overlay" class="blur-overlay"></div>
</div>

        <div id="map"></div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-control-geocoder.Geocoder.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="data/Monuments_3.js"></script>
        <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
        <script>
        
        // Function to hide the welcome screen when the button is clicked
document.getElementById('welcome-button').addEventListener('click', function () {
    const welcomeScreen = document.getElementById('welcome-screen');
    welcomeScreen.style.transition = 'opacity 0.5s';
    welcomeScreen.style.opacity = '0';
    setTimeout(() => {
        welcomeScreen.style.display = 'none';
        startTaskTimer(1); // <-- Start the timer for Task 1 here!
    }, 500);
});

        // 🟢 MAP INITIALIZATION
var map = L.map('map', {
    zoomControl: false,
    maxZoom: 28,
    minZoom: 1
}).setView([51.944, 20.654], 5); // [lat, lng], zoom
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // 🟢 POPUP UTILITIES
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                setTimeout(function() {
                    popup.update();
                }, 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        // 🟢 MAP CONTROLS
        var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
        L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

        // 🟢 BASEMAPS
        var bounds_group = new L.featureGroup([]);
        function setBounds() {}
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.createPane('pane_GoogleSatellite_1');
        map.getPane('pane_GoogleSatellite_1').style.zIndex = 401;
        var layer_GoogleSatellite_1 = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            pane: 'pane_GoogleSatellite_1',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 22
        });
        layer_GoogleSatellite_1;
        map.createPane('pane_CartoDark_2');
        map.getPane('pane_CartoDark_2').style.zIndex = 402;
        var layer_CartoDark_2 = L.tileLayer('https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}@2x.png', {
            pane: 'pane_CartoDark_2',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 18
        });
        layer_CartoDark_2;
        map.addLayer(layer_CartoDark_2);

        // 🟢 BASEMAP CONTROL (top right)
            var baseMaps = {
            "OpenStreetMap": layer_OpenStreetMap_0,
            "Google Satellite": layer_GoogleSatellite_1,
            "Carto Dark": layer_CartoDark_2
            };
            L.control.layers({ "Carto Dark": layer_CartoDark_2, "OpenStreetMap": layer_OpenStreetMap_0, "Google Satellite": layer_GoogleSatellite_1 }).addTo(map);

            // Listen for basemap change to complete Task 4
map.on('baselayerchange', function(e) {
    if (window._task4Active && !window._task4Completed) {
        window._task4Completed = true;
        if (typeof tasks !== "undefined" && tasks[3] && tasks[3].check && currentTask === 3 && tasks[3].check()) {
            completeCurrentTask();
        }
    }
});
        // Add a "Basemaps" header to the basemap selector panel
        setTimeout(function() {
            var list = document.querySelector('.leaflet-control-layers-base');
            if (list && !list.querySelector('.custom-basemap-header')) {
                var header = document.createElement('div');
                header.textContent = 'Basemaps';
                header.className = 'custom-basemap-header';
                list.insertBefore(header, list.firstChild);
            }
        }, 300);

// 🟢 MONUMENTS LAYER AND POPUP
function pop_Monuments_3(feature, layer) {
    // ...inside pop_Monuments_3...
layer.on('click', function(e) {
    showMonumentInfoOverlay(feature);

    // Ensure overlay audio interrupts hover sound
setTimeout(() => {
    const overlayAudio = document.querySelector('#tab-audio audio');
    if (overlayAudio) {
        overlayAudio.addEventListener('play', function() {
            if (window._monumentAudio && !window._monumentAudio.paused) {
                window._monumentAudio.pause();
                window._monumentAudio.currentTime = 0;
            }
        });
    }
}, 0);
});}

//Play sound when hovering over monuments

function playMonumentSound(src) {
    if (window._monumentAudio) {
        window._monumentAudio.pause();
        window._monumentAudio.currentTime = 0;
    }
    window._monumentAudio = new Audio(src);
    window._monumentAudio.play();
}

        // 🟢 MONUMENTS LAYER
var infoIcon = L.icon({
    iconUrl: 'markers/info.png',
    iconSize: [16, 16],
    iconAnchor: [8, 16],    // Center bottom
    popupAnchor: [0, -16]
});

var layer_Monuments_3 = new L.geoJson(json_Monuments_3, {
    attribution: '',
    interactive: true,
    dataVar: 'json_Monuments_3',
    layerName: 'layer_Monuments_3',
    pane: 'pane_Monuments_3',
    onEachFeature: pop_Monuments_3, // <-- Add this line
    pointToLayer: function (feature, latlng) {
        return L.marker(latlng, { icon: infoIcon });
    }
});
        bounds_group.addLayer(layer_Monuments_3);

// Add a variable to track the last played monument
window._lastMonumentName = null;

function playMonumentSound(src, monumentName) {
    // Only interrupt if a different monument is hovered
    if (window._lastMonumentName !== monumentName) {
        if (window._monumentAudio) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
        window._monumentAudio = new Audio(src);
        window._monumentAudio.play();
        window._lastMonumentName = monumentName;
    }
    // If the same monument, do nothing (let the sound continue)
}

// Helper: Check if any popup audio is playing
function isPopupAudioPlaying() {
    const audios = document.querySelectorAll('.leaflet-popup .audio');
    for (let audio of audios) {
        if (!audio.paused && !audio.ended) {
            return true;
        }
    }
    return false;
}

// Listen for play events on popup audio to stop hover audio
document.addEventListener('play', function(e) {
    if (e.target.classList.contains('audio') && e.target.closest('.leaflet-popup')) {
        // Stop hover audio if playing
        if (window._monumentAudio && !window._monumentAudio.paused) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
    }
}, true);

// Listen for pause and ended events on popup audio to allow replay of hover audio
document.addEventListener('pause', function(e) {
    if (e.target.classList.contains('audio') && e.target.closest('.leaflet-popup')) {
        window._lastMonumentName = null;
    }
}, true);

document.addEventListener('ended', function(e) {
    if (e.target.classList.contains('audio') && e.target.closest('.leaflet-popup')) {
        window._lastMonumentName = null;
    }
}, true);

// Update playMonumentSound to respect popup audio
function playMonumentSound(src, monumentName) {
    if (isPopupAudioPlaying()) {
        return;
    }
    if (window._lastMonumentName !== monumentName) {
        if (window._monumentAudio) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
        window._monumentAudio = new Audio(src);
        window._monumentAudio.play();
        window._lastMonumentName = monumentName;

        // When hover audio ends, allow replay on next hover
        window._monumentAudio.onended = function() {
            window._lastMonumentName = null;
        };
    }
}

// Update playMonumentSound to allow replay after audio ends
function playMonumentSound(src, monumentName) {
    if (isPopupAudioPlaying()) {
        return;
    }
    if (window._lastMonumentName !== monumentName) {
        if (window._monumentAudio) {
            window._monumentAudio.pause();
            window._monumentAudio.currentTime = 0;
        }
        window._monumentAudio = new Audio(src);
        window._monumentAudio.play();
        window._lastMonumentName = monumentName;

        // When hover audio ends, allow replay on next hover
        window._monumentAudio.onended = function() {
            window._lastMonumentName = null;
        };
    }
}

layer_Monuments_3.eachLayer(function(marker) {
    marker.on('mouseover', function(e) {
        var icon = e.target._icon;
        if (icon) {
            icon.style.transition = 'width 0.2s, height 0.2s';
            icon.style.width = '20px';
            icon.style.height = '20px';
            icon.style.zIndex = 1001;
        }
        // Play sound based on Name attribute
        var feature = e.target.feature;
if (feature && feature.properties && feature.properties['Name']) {
    if (feature.properties['Name'] === 'Big Ben') {
        playMonumentSound('sounds/LondonHover.mp3', 'Big Ben');
    } else if (feature.properties['Name'] === 'Brandenburg Gate') {
        playMonumentSound('sounds/BerlinHover.mp3', 'Brandenburg Gate');
    } else if (feature.properties['Name'] === 'Colosseum') {
        playMonumentSound('sounds/RomeHover.mp3', 'Colosseum');
    } else if (feature.properties['Name'] === 'Eiffel Tower') {
        playMonumentSound('sounds/ParisHover.mp3', 'Eiffel Tower');
    } else if (feature.properties['Name'] === 'The Parthenon') {
        playMonumentSound('sounds/AthensHover.mp3', 'The Parthenon');
    } else if (feature.properties['Name'] === 'Leaning Tower of Pisa') {
        playMonumentSound('sounds/PisaHover.mp3', 'Leaning Tower of Pisa');
    } else if (feature.properties['Name'] === 'White Tower of Thessaloniki') {
        playMonumentSound('sounds/ThessalonikiHover.mp3', 'White Tower of Thessaloniki');
    } else if (feature.properties['Name'] === 'Hagia Sophia') {
        playMonumentSound('sounds/IstanbulHover.mp3', 'Hagia Sophia');
    } else if (feature.properties['Name'] === 'Edinburgh Castle') {
        playMonumentSound('sounds/ScotlandHover.mp3', 'Edinburgh Castle');
    } else if (feature.properties['Name'] === 'St. Basil\'s Cathedral') {
        playMonumentSound('sounds/RussiaHover.mp3', 'St. Basil\'s Cathedral');
    } else if (feature.properties['Name'] === 'The Atomium') { // 🟢 Add this line for Atomium
        playMonumentSound('sounds/AtomiumHover.mp3', 'The Atomium');
    }
}
    });
    marker.on('mouseout', function(e) {
        var icon = e.target._icon;
        if (icon) {
            icon.style.width = '16px';
            icon.style.height = '16px';
            icon.style.zIndex = '';
        }
        // Do NOT stop the sound here anymore!
    });
    map.addLayer(layer_Monuments_3);
});
// Overlay tab logic
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const tab = this.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tc => {
            tc.classList.remove('active');
            tc.style.display = 'none';
        });
        const activeTab = document.getElementById('tab-' + tab);
        activeTab.classList.add('active');
        activeTab.style.display = 'flex';
    });
});

function closeMonumentOverlay() {
    const overlay = document.getElementById('monument-overlay');
    const blur = document.getElementById('blur-overlay');
        const now = Date.now();
    if (currentTab && tabLastEnterTime[currentTab] !== null) {
        tabTotalTimes[currentTab] += (now - tabLastEnterTime[currentTab]) / 1000;
        tabLastEnterTime[currentTab] = null;
    }
    currentTab = null;
    overlay.classList.remove('open');
    blur.style.opacity = 0;
    setTimeout(() => {
        overlay.style.display = 'none';
        blur.style.display = 'none';
    }, 500);
}

// Close overlay when clicking outside the overlay (on blur-overlay)
document.getElementById('blur-overlay').addEventListener('click', closeMonumentOverlay);

// Close overlay when pressing Escape
document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape') closeMonumentOverlay();
});


function showMonumentInfoOverlay(feature) {
    window._lastMonumentNameClicked = feature.properties.Name; // <-- Add this line at the top

    // --- Mappings (same as index3 - Copy.html) ---
    const imageMap = { 0: 'images/BIGBEN.jpg', 1: 'images/GATE.png', 2: 'images/ROME.jpg', 3: 'images/PARIS.png', 4: 'images/PARTHENON.jpg', 5: 'images/PISA.jpg', 6: 'images/THESSALONIKI.jpg', 7: 'images/ISTANBUL.jpg', 8: 'images/EDINBURGH.jpg', 9: 'images/STBASIL.jpg', 10: 'images/ATOMIUM.jpg' }; // 🟢 Add Atomium image
    const audioImgMap = {
        0: 'images/LondonRadio.png',
        1: 'images/BerlinRadio.png',
        2: 'images/ColosseumRadio.png',
        3: 'images/ParisRadio.png',
        4: 'images/AthensRadio.png',
        5: 'images/PisaRadio.png',
        6: 'images/ThessalonikiRadio.png',
        7: 'images/IstanbulRadio.png',
        8: 'images/ScotlandRadio.png',
        9: 'images/RussiaRadio.png',
        10: 'images/AtomiumRadio.png' // 🟢 Add this line for Atomium
    };
    const audioSrcMap = {
        0: 'sounds/LondonAudioGuide.mp3',
        1: 'sounds/BerlinAudioGuide.mp3',
        2: 'sounds/RomeAudioGuide.mp3',
        3: 'sounds/ParisAudioGuide.mp3',
        4: 'sounds/TheParthenonAudioGuide.mp3',
        5: 'sounds/PisaAudioGuide.mp3',
        6: 'sounds/ThessalonikiAudioGuide.mp3',
        7: 'sounds/IstanbulAudioGuide.mp3',
        8: 'sounds/ScotlandAudioGuide.mp3',
        9: 'sounds/RussiaAudioGuide.mp3',
        10: 'sounds/AtomiumAudioGuide.mp3' // 🟢 Add this line for Atomium
    };

    const videoMap = { // 🟢 Add this mapping
        0: 'https://ia601203.us.archive.org/20/items/athens-video/LondonVideo.mp4',
        1: 'https://ia601203.us.archive.org/20/items/athens-video/BerlinVideo.mp4',
        2: 'https://ia601203.us.archive.org/20/items/athens-video/VideoColosseum.mp4',
        3: 'https://ia601203.us.archive.org/20/items/athens-video/ParisVideo.mp4',
        4: 'https://ia601203.us.archive.org/20/items/athens-video/AthensVideo.mp4',
        5: 'https://ia601203.us.archive.org/20/items/athens-video/PisaVideo.mp4',
        6: 'https://ia601203.us.archive.org/20/items/athens-video/ThessalonikiVideo.mp4',
        7: 'https://ia601203.us.archive.org/20/items/athens-video/IstanbulVideo.mp4',
        8: 'https://ia600202.us.archive.org/13/items/EDINBURGHVideo/EDINBURGHVideo.mp4',
        9: 'https://ia600901.us.archive.org/16/items/russia_202506/RUSSIA.ia.mp4',
        10: 'https://ia801507.us.archive.org/35/items/atomuum-video/AtomuumVideo.mp4'
    };

    const modelMap = {
        0: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/LONDON.glb',
        1: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/BERLIN.glb',
        2: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/ROME.glb',
        3: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/PARIS.glb',
        4: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/ATHENS.glb',
        5: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/PISA.glb',
        6: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/THESSALONIKI.glb',
        7: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/ISTANBUL.glb',
        8: 'sketchfab',
        9: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/RUSSIA.glb',
        10: 'https://raw.githubusercontent.com/eftsev/3dmodels/main/model1/ATOMIUM.glb'

    };
    const qrMap = { 0: 'images/LondonQR.png', 1: 'images/BerlinQR.png', 2: 'images/ColosseumQR.png', 3: 'images/ParisQR.png', 4: 'images/AthensQR.png', 5: 'images/PisaQR.png', 6: 'images/ThessalonikiQR.png', 7: 'images/IstanbulQR.png', 8: 'images/ScotlandQR.png', 9: 'images/RussiaQR.png', 10: 'images/AtomiumQR.png' };

// --- Info Tab ---
const country = feature.properties.Country || '';
const city = feature.properties.City || '';
// Map country names to flag image filenames
const flagMap = {
    'Greece': 'GREECE.png',
    'England': 'UK.png',
    'Germany': 'GERMANY.jpg',
    'Italy': 'ITALY.png',
    'France': 'FRANCE.png',
    'Spain': 'SPAIN.png',
    'Turkey': 'TURKEY.jpg',
    'Scotland': 'SCOTLAND.jpg',
    'Russia': 'RUSSIA.png',
    'Belgium': 'BELGIUM.png',



    // Add more as needed
};
const flagFile = flagMap[country] ? `images/${flagMap[country]}` : '';
const flagImgHtml = flagFile
    ? `<br><img src="${flagFile}" alt="${country} flag" style="margin-top:24px;max-width:300px;max-height:225px;border-radius:7px;border:1px solid #ccc;">`
    : '';

document.getElementById('tab-info').innerHTML = `
    <div style="font-family: Arial, sans-serif;">
        <div style="font-weight: bold; font-size: 30px; margin-bottom: 30px;">
            ${feature.properties.Name || ''}
        </div>
        <div style="font-size: 20px; margin-bottom: 40px;">
            ${city}${city && country ? ', ' : ''}${country}
        </div>
        ${flagImgHtml}
    </div>
`;
document.getElementById('tab-info').style.fontFamily = "Arial, sans-serif";

// --- Description Tab (map number to text) ---
const descriptionMap = {
    0: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">Big Ben</strong><br><br>
            Big Ben is the nickname for the Great Bell housed within the Elizabeth Tower at the north end of the Palace of Westminster in London. Though commonly used to refer to the entire structure, “Big Ben” originally referred only to the bell itself. The tower was completed in 1859 and renamed the Elizabeth Tower in 2012 to mark Queen Elizabeth II’s Diamond Jubilee.<br><br>
            Standing 96 meters tall, the tower was designed in the neo-Gothic style by Augustus Pugin, working with architect Charles Barry. Constructed from brick and clad in limestone, the tower features a cast iron spire and four large clock dials, each measuring seven meters in diameter. The clock’s minute hands are over four meters long, while the hour hands are shorter and made of gunmetal.<br><br>
            The Great Bell weighs approximately 13.5 tons and produces its iconic chime on the hour. It cracked shortly after being installed but was repaired by rotating it and fitting a lighter hammer, resulting in the distinctive tone still heard today. The tower also contains four smaller quarter bells, which chime every fifteen minutes.<br><br>
            The clock mechanism, designed by Edward John Dent, is known for its precision. Traditional penny coins are still used to regulate the pendulum. Despite wartime bombings and major renovations, the clock has remained a lasting symbol of British resilience and tradition.<br><br>
            Today, Big Ben continues to function as a working clock and a timekeeping symbol of Parliament. The chimes are used for ceremonial occasions, national events, and are broadcast live by the BBC, maintaining its role as a cultural and political icon.
        </div>`,
    1: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">The Brandenburg Gate</strong><br><br>
            The Brandenburg Gate is one of Berlin's most iconic landmarks, symbolizing both the tumultuous history and the unity of Germany. Completed in 1791, it was commissioned by King Frederick William II of Prussia and designed by Karl Gotthard Langhans.<br><br>
            The neoclassical monument stands at the western end of Unter den Linden and features 12 Doric columns, forming five passageways.<br><br>
            Topped by the Quadriga, a chariot drawn by four horses driven by the goddess of victory, it has witnessed many pivotal historical moments. During the Cold War, the gate stood in a no-man's land between East and West Berlin, becoming a symbol of division.<br><br>
            However, in 1989, when the Berlin Wall fell, it transformed into a powerful emblem of reunification. <br><br>
            Today, the Brandenburg Gate stands not only as a major tourist attraction but also as a national symbol of peace, unity and resilience. It continues to host national, cultural, political and several sports events and celebrations.
        </div>`,
    2: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">The Colosseum</strong><br><br>
            The Colosseum is an elliptical amphitheater in the center of the city of Rome, Italy, just east of the Roman Forum. Construction began under the Emperor Vespasian in 72 A.D. and was completed in 80 A.D. under his successor and heir, Titus. Further modifications were made during the reign of Domitian.<br><br>
            The three emperors who were patrons of the work are known as the Flavian dynasty, and originally the amphitheater was named the Flavian Amphitheater by later classicists and archaeologists for its association with their family name, Flavius.<br><br>
            The height of the Colosseum is 157 feet, or 48 meters, and the base area is 6 acres, or 24,000 square meters. This means that it is taller than a 16-story building and it has enough room for more than three football fields.<br><br>
            The Colosseum is built of travertine limestone, tough volcanic rock, and brick-faced concrete. It could hold an estimated 50,000 to 80,000 spectators at various points in its history, having an average audience of some 65,000. It was used for gladiatorial contests and public spectacles, including animal hunts, executions, reenactments of famous battles, dramas based on Roman mythology, and briefly mock sea battles.<br><br>
            The building ceased to be used for entertainment in the early medieval era. It was later reused for such purposes as housing, workshops, quarters for a religious order, a fortress, a quarry, and a Christian temple. Although substantially ruined by earthquakes and stone robbers taking spolia, the Colosseum is still a renowned symbol of Imperial Rome and was listed as one of the New Seven Wonders of the World.
        </div>`,
    3: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">Eiffel Tower</strong><br><br>
            The Eiffel Tower is a wrought-iron lattice structure located on the Champ de Mars in Paris, France. It was designed by engineer Gustave Eiffel and constructed between 1887 and 1889 as the entrance arch for the 1889 Exposition Universelle, held to celebrate the centenary of the French Revolution. At the time of completion, it was the tallest man-made structure in the world, standing at 300 meters, later extended to 330 meters with antennas.<br><br>
            Constructed from over 18,000 iron parts and held together by 2.5 million rivets, the tower was initially met with criticism from artists and intellectuals. However, it eventually became one of the most recognizable landmarks in the world. The tower has three public viewing levels, with restaurants on the first and second floors, and an observation deck at the top offering panoramic views of Paris.<br><br>
            The Eiffel Tower weighs approximately 10,100 tons and expands by up to 15 centimeters in the summer due to thermal expansion. It is repainted roughly every seven years to protect the iron from rust and environmental damage. Originally intended to stand for only 20 years, it was preserved due to its usefulness as a radio transmission tower.<br><br>
            Today, the Eiffel Tower remains a functioning broadcast tower and one of the most visited monuments globally. It hosts millions of tourists annually, features cultural exhibitions, light displays, and serves as a national symbol of innovation, French identity, and architectural achievement.
        </div>`,
    4: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">The Parthenon</strong><br><br>
            The Parthenon is an ancient Greek temple located on the Acropolis of Athens, dedicated to the goddess Athena, the city's patron deity. Constructed between 447 and 432 BCE during the height of the Athenian Empire, it was designed by architects Iktinos and Kallikrates under the supervision of the sculptor Phidias. The structure replaced an earlier temple destroyed during the Persian invasion of 480 BCE.<br><br>
            Built primarily from Pentelic marble, the Parthenon exemplifies the Doric order, though it incorporates Ionic elements. It features eight columns on the façade and seventeen along the sides, with subtle architectural refinements such as a curved base and slightly tilted columns to correct optical illusions. The temple originally housed a massive chryselephantine (gold and ivory) statue of Athena, created by Phidias.<br><br>
            The Parthenon served various roles over the centuries, including a treasury, a Christian church, a mosque, and even an ammunition depot, which led to significant damage during a 17th-century explosion. Despite this, it remains a symbol of ancient Greek civilization and classical ideals of harmony and proportion.<br><br>
            Today, the Parthenon stands as a major archaeological site and cultural monument. It is preserved and studied as part of ongoing restoration efforts by the Greek government and international experts. It continues to represent the legacy of ancient Athens, attracting millions of visitors annually and symbolizing the enduring influence of classical architecture and democracy.
        </div>`,
    5: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">The Leaning Tower of Pisa</strong><br><br>
    The Leaning Tower of Pisa is a freestanding bell tower, or campanile, of the cathedral in Pisa, Italy. Construction began in 1173 and continued intermittently over nearly two centuries, finally completing in the 14th century. The tower is famous worldwide for its unintended tilt, caused by unstable foundation soil beneath its base.<br><br>
    Standing about 56 meters tall on the high side, the tower is made of white and grey marble and features eight stories, including the chamber for the seven bells. Its design follows Romanesque architectural style, characterized by rounded arches, columns, and decorative arcading around each level.<br><br>
    The tilt began during construction, when the foundation on one side started to sink into soft ground composed of clay, sand, and shells. Various efforts to correct or stabilize the lean have been made over the centuries, with modern engineering successfully reducing the tilt to about 3.97 degrees, ensuring the tower’s safety while preserving its distinctive angle.<br><br>
    The tower’s lean has made it a symbol of architectural curiosity and resilience, attracting millions of visitors annually. It continues to serve as the bell tower for Pisa’s cathedral and is part of the Piazza dei Miracoli, a UNESCO World Heritage Site, representing medieval Italian art and engineering ingenuity.
        </div>`,          
    6: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">The White Tower</strong><br><br>
    The White Tower is a prominent historical monument and museum located on the waterfront of Thessaloniki, Greece. Built in the late 15th century by the Ottomans after their conquest of the city, the tower replaced an older Byzantine fortification and became part of the city’s seafront defensive walls. Standing approximately 34 meters high with a diameter of 22 meters, it was constructed as a cylindrical structure with a flat roof and six interior floors connected by a spiral staircase.<br><br>
    Originally used as a fortress and garrison, the tower also served as a prison and place of execution during the Ottoman period, earning it the nickname "Tower of Blood" or "Red Tower." It was whitewashed and renamed the "White Tower" in the late 19th century, possibly to symbolize a new era and cleanse its dark past.<br><br>
    Architecturally, the White Tower is an example of late medieval military design, combining defensive features with a commanding view of the sea and surrounding city. The outer wall, which once enclosed the tower, was demolished in the early 20th century, leaving the structure as a free-standing monument.<br><br>
    Today, the White Tower functions as a museum managed by the Ephorate of Antiquities. It hosts permanent exhibitions on the history of Thessaloniki from antiquity through the modern era. The top of the tower offers panoramic views of the city and Thermaic Gulf. It stands as a symbol of Thessaloniki’s layered past and its evolving identity through centuries of cultural and political change.
        </div>`,        
    7: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
            <strong style="font-size: 24px;">Hagia Sophia</strong><br><br>
    Hagia Sophia is a monumental architectural masterpiece located in Istanbul, Turkey, originally constructed as a cathedral between 532 and 537 CE during the reign of Byzantine Emperor Justinian the First.<br><br>
    Renowned for its massive central dome, it was the largest cathedral in the world for nearly a thousand years and is considered a pinnacle of Byzantine architecture.<br><br>
    The building’s design features a vast nave topped by a 31-meter diameter dome, which appears to float above the space thanks to a ring of windows at its base, creating a sense of divine light. The structure combines a basilica layout with a centralized dome plan, supported by pendentives that transfer the dome’s weight onto four massive piers.<br><br>
    The interior is richly decorated with mosaics depicting religious figures, geometric patterns, and intricate marble work. The use of light and space inside Hagia Sophia creates an awe-inspiring atmosphere, reflecting its original purpose as a place of worship and imperial ceremony.<br><br>
    Its architectural innovations influenced many churches and other buildings for centuries. Today, Hagia Sophia functions as a mosque and remains a UNESCO World Heritage site, admired globally for its historical significance, architectural brilliance, and artistic heritage.
        </div>`,
    8: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">Edinburgh Castle</strong><br><br>
    Edinburgh Castle is a historic fortress located on Castle Rock, a volcanic promontory that dominates the skyline of Scotland’s capital. Archaeological evidence suggests the site has been occupied since at least the Iron Age, but the earliest royal castle on the rock dates back to the 12th century during the reign of King David I.<br><br>
    Over the centuries, the castle has served as a royal residence, military stronghold, and symbol of Scottish power. Its strategic position made it central to many conflicts, including the Wars of Scottish Independence and later struggles between crown and parliament. Despite repeated sieges, it remained a key seat of authority in Scotland.<br><br>
    The castle complex includes a variety of buildings, reflecting different historical periods. Highlights include St. Margaret’s Chapel constructed in the early 12th century, the Great Hall completed in the 16th century, and the Royal Palace, which houses the Honours of Scotland (the Scottish Crown Jewels) and the Stone of Destiny.<br><br>
    Architecturally, the castle showcases medieval and early modern styles, with thick defensive walls, towers, and gates integrated into the rugged landscape. It is both a national monument and a working military site.
</div>`,
    9: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">St. Basil's Cathedral</strong><br><br>
    St. Basil’s Cathedral is an architectural monument located at the southern end of Red Square in Moscow, Russia. It was commissioned by Ivan IV, and constructed between 1555 and 1561 to commemorate the capture of Kazan and Astrakhan.<br><br>
    The cathedral consists of a central church surrounded by eight smaller chapels, each built to honor a specific military victory. These chapels are arranged symmetrically around the central core and are connected by a maze-like system of galleries and passageways. The entire structure rests on a single foundation, unified by a raised platform.<br><br>
    St. Basil’s is most famous for its vibrant, onion-shaped domes, each uniquely decorated with colorful patterns and textures. The design combines traditional Russian architectural elements with influences from Byzantine and Asian styles, creating a highly distinctive silhouette that has become a symbol of Moscow and Russia itself.<br><br>
    Originally painted in more subdued tones, the cathedral received its vivid color scheme in later centuries. Inside, it features narrow corridors, steep stairways, and richly decorated chapels with frescoes, icons, and ornamental details.<br><br>
    Today, St. Basil’s functions as a museum and stands as a UNESCO World Heritage Site. It is widely recognized as a masterpiece of Russian medieval architecture and remains a cultural and national icon.
        </div>`,
            10: `<div style="text-align: justify; font-family: Arial; font-size: 18px;">
    <strong style="font-size: 24px;">The Atomium</strong><br><br>
    The Atomium is a unique architectural structure and museum located in Brussels, Belgium. It was originally built for Expo 58, the 1958 Brussels World’s Fair, as the centerpiece of the exhibition. Designed by engineer André Waterkeyn and architects André and Jean Polak, the structure represents an iron crystal magnified 165 billion times.<br><br>
    Standing 102 meters tall, the Atomium consists of nine stainless steel-clad spheres, each 18 meters in diameter, connected by tubes housing escalators and stairs. The spheres are arranged to reflect the geometric pattern of a unit cell of iron, symbolizing scientific progress and the optimism of the atomic age. Three of the spheres are not accessible to the public, while the others house exhibitions, event spaces, and a panoramic viewing deck.<br><br>
    Originally intended as a temporary structure, the Atomium was preserved due to its popularity and has since become an enduring landmark of Brussels. It underwent extensive renovation in the early 2000s to modernize its facilities.<br><br>
    Today, the Atomium functions as both a museum and a cultural venue. It hosts permanent and temporary exhibitions focused on science, design, and history, while the top sphere offers a 360-degree view of Brussels and its surroundings. The Atomium remains a powerful symbol of mid-20th century innovation, European unity, and Belgium’s place in the modern scientific world.
        </div>`
};
const descValue = feature.properties.Description;
document.getElementById('tab-desc').innerHTML =
    descriptionMap.hasOwnProperty(descValue)
        ? descriptionMap[descValue]
        : (descValue || "No description available.");

    // --- Image Tab ---
    const imageSrc = imageMap[feature.properties.Image];
    document.getElementById('tab-img').innerHTML = imageSrc
        ? `<img src="${imageSrc}" alt="Monument Image" style="max-width:100%;max-height:100%;border-radius:8px;">`
        : 'No image available.';

// --- Audio Tab ---
const audioImg = audioImgMap[feature.properties.Audio];
const audioSrc = audioSrcMap[feature.properties.Audio];
document.getElementById('tab-audio').innerHTML = (audioImg && audioSrc)
    ? `<div style="position: relative; width: 800px; height: 123px;">
           <img src="${audioImg}" style="width: 100%; height: 100%; border-radius: 7px; border: 2px solid black;">
           <audio controls class="audio" 
                  style="position: absolute; bottom: 30px; left: 335px; transform: translateX(-50%) scale(1.15); transform-origin: center; width: 70%;">
               <source src="${audioSrc}" type="audio/mpeg">
           </audio>
       </div>`
    : 'No audio available.';

    // --- Video Tab --- // 🟢 Add this block
    const videoSrc = videoMap[feature.properties.Video];
    document.getElementById('tab-video').innerHTML = videoSrc
        ? `<video controls style="max-width:100%;max-height:100%;border-radius:8px;">
                <source src="${videoSrc}" type="video/mp4">
                Your browser does not support the video tag.
           </video>`
        : 'No video available.';

// --- 3D Model Tab ---
const modelSrc = modelMap[feature.properties['3D Model']];
document.getElementById('tab-model').innerHTML =
    modelSrc === 'sketchfab'
        ? `<div class="sketchfab-embed-wrapper">
                <div class="sketchfab-embed-wrapper"> <iframe title="Edinburgh Castle" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/b494fdf5e2754259bc90c536b18fcfff/embed?autostart=1&camera=0&annotations_visible=0&transparent=1&ui_animations=0&ui_infos=0&ui_stop=0&ui_inspector=0&ui_watermark_link=0&ui_watermark=0&ui_hint=0&ui_ar=0&ui_help=0&ui_settings=0&ui_vr=0&ui_fullscreen=0&ui_annotations=0"> </iframe> </div>
           </div>`
        : (modelSrc
            ? `<model-viewer src="${modelSrc}" camera-controls auto-rotate style="width: 100%; height: 100%; background: #f8f8f8; border-radius: 8px;"></model-viewer>`
            : 'No 3D model available.');
// ...existing code... 

    // --- QR Tab ---
    const qrSrc = qrMap[feature.properties['QR Code']];
    document.getElementById('tab-qr').innerHTML = qrSrc
        ? `<img src="${qrSrc}" height="100%" style="cursor: pointer; border-radius:8px;">`
        : 'No QR code available.';

    // Show overlay with animation
    const overlay = document.getElementById('monument-overlay');
    overlay.style.display = 'flex';
    setTimeout(() => overlay.classList.add('open'), 10);

    const blur = document.getElementById('blur-overlay');
    blur.style.display = 'block';
    setTimeout(() => blur.style.opacity = 1, 10);

    // Default to Info tab
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
    document.querySelector('.tab-btn[data-tab="info"]').classList.add('active');
    document.getElementById('tab-info').style.display = 'flex';
}

function closeMonumentOverlay() {
    // Stop all audio in the overlay
    document.querySelectorAll('#monument-overlay audio').forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
    });

    const overlay = document.getElementById('monument-overlay');
    const blur = document.getElementById('blur-overlay');
    overlay.classList.remove('open');
    blur.style.opacity = 0;
    setTimeout(() => {
        overlay.style.display = 'none';
        blur.style.display = 'none';
    }, 500);
}

// Carousel slides content (replace with your actual instructions later)

const carouselSlides = [
    `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;margin-bottom:10px;">
        <h2 style="text-align:center;width:100%;">Web App Instructions</h2>
        <p style="text-align:center;width:100%; font-family: Arial;">
            Welcome to the Interactive European Monuments Web App!<br><br>
            In this application, you will explore famous monuments across Europe using an interactive map.<br><br>
            You will be guided through a series of simple tasks, such as viewing monument information, exploring 3D models, listening to audio guides, and more.<br><br>
            Your progress will be tracked, and at the end, you’ll be asked to complete a short questionnaire.
        </p>
        <div style="font-weight:bold; font-family:Arial; margin-top:80px; margin-bottom:8px; font-size:1.13em; text-align:center;">
            Please enter a 6-digit code of your choice below.
        </div>
<div style="color:#c0392b; background:#fffbe6; border:1px solid #ffe58f; border-radius:6px; padding:16px 24px; margin-bottom:12px; font-size:1.08em; max-width:600px; text-align:center; font-family:Arial;">
    <b>Hint!</b> You will need this code to proceed to Part 2 of the research, so enter a 6-digit code you can remember.
        </div>
        <input id="user-code-input" type="text" maxlength="6" pattern="\\d{6}" 
            style="font-size:1.3em;padding:8px 16px;width:180px;text-align:center;border-radius:6px;border:1px solid #bbb;letter-spacing:0.3em;margin-top:10px;display:block;font-family:Arial;" autocomplete="off" />
        <div id="code-error-msg" style="color:#c0392b;font-size:1em;margin-top:8px;height:22px;visibility:hidden;text-align:center;font-family:Arial;">
            The code must be 6 digits.
        </div>
    </div>`,
    `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;margin-bottom:10px;">
        <h2 style="text-align:center;width:100%;">How Tasks Work</h2>
        <p style="text-align:center;width:100%; font-family: Arial;">
            As you use the app, <b>tasks will appear at the bottom of the screen</b>.<br>
            Each task guides you through a specific action.
        </p>
        <img src="images/Picture16.png" alt="Task Example" style="max-width:80%;width:100%;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.10);margin:32px 0 32px 0;">
        <p style="text-align:center;width:100%; font-family: Arial;">
            When you complete a task, <b>you will hear a sound</b> and the task text will turn <span style="color:#27ae60;font-weight:bold;">green</span>.<br>
            The next task will then appear automatically.<br>
            There are a total of <b>10 tasks</b> to complete.
        </p>
    </div>`,
    `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;margin-bottom:10px;">
        <h2 style="text-align:center;width:100%;">Finishing Tasks</h2>
        <p style="text-align:center;width:100%; font-family: Arial;">
            Upon completion click the "Proceed to Questionaire" button, to continue to <b>Part 2 of the research</b>.<br>
            <b>You can then explore the app without any limitations.</b><br>
        </p>
        <img src="images/Picture17.png" alt="Task Example" style="max-width:50%;width:100%;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.10);margin:32px 0 32px 0;">
        <p style="text-align:center;width:100%; font-family: Arial;">
        </p>
    </div>`
];

let userSixDigitCode = ""; // Store the code in JS

// --- Update renderCarouselSlides to gray out and disable "Previous" on slide 2 ---
function renderCarouselSlides(newIdx, direction = 0) {
    const slidesDiv = document.getElementById('carousel-slides');
    while (slidesDiv.firstChild) slidesDiv.removeChild(slidesDiv.firstChild);

    const prevSlideEl = document.createElement('div');
    prevSlideEl.className = 'carousel-slide active';
    prevSlideEl.innerHTML = carouselSlides[lastSlide];

    const newSlideEl = document.createElement('div');
    newSlideEl.className = 'carousel-slide';
    newSlideEl.innerHTML = carouselSlides[newIdx];

    if (direction === 0) {
        newSlideEl.classList.add('active');
        slidesDiv.appendChild(newSlideEl);
    } else {
        slidesDiv.appendChild(prevSlideEl);
        slidesDiv.appendChild(newSlideEl);
        void prevSlideEl.offsetWidth;
        prevSlideEl.classList.remove('active');
        prevSlideEl.classList.add(direction > 0 ? 'slide-out-left' : 'slide-out-right');
        newSlideEl.classList.add(direction > 0 ? 'slide-in-right' : 'slide-in-left');
        setTimeout(() => {
            slidesDiv.innerHTML = '';
            newSlideEl.className = 'carousel-slide active';
            slidesDiv.appendChild(newSlideEl);
        }, 450);
    }

    // Dots
    const dotsDiv = document.getElementById('carousel-dots');
    dotsDiv.innerHTML = '';
for (let i = 0; i < carouselSlides.length; i++) {
    const dot = document.createElement('span');
    dot.style.width = '13px';
    dot.style.height = '13px';
    dot.style.borderRadius = '50%';
    dot.style.display = 'inline-block';
    dot.style.background = i === newIdx ? '#2563eb' : '#bbb';
    dot.style.cursor = 'pointer';

    // Prevent moving to slides > 0 if code not submitted
    if ((i > 0 && !userSixDigitCode) || (i === 0 && currentSlide > 0)) {
        // Do not assign onclick, so it's not clickable
    } else {
        dot.onclick = () => {
            if (i !== currentSlide) {
                lastSlide = currentSlide;
                currentSlide = i;
                renderCarouselSlides(currentSlide, i > lastSlide ? 1 : -1);
            }
        };
    }
    dotsDiv.appendChild(dot);
}

// Prevent moving forward if code not submitted
if (!userSixDigitCode && newIdx > 0) {
    // If trying to render slide 2 or 3 without code, force back to slide 0
    setTimeout(() => {
        lastSlide = newIdx;
        currentSlide = 0;
        renderCarouselSlides(0, -1);
    }, 0);
    return;
}

    // Checkbox logic
    const checkboxRow = document.getElementById('carousel-checkbox-row');
    const agreeCheckbox = document.getElementById('carousel-agree-checkbox');
    const nextBtn = document.getElementById('carousel-next');
    const prevBtn = document.getElementById('carousel-prev');
    if (newIdx === carouselSlides.length - 1) {
        checkboxRow.style.display = 'flex';
        nextBtn.textContent = 'Start';
        nextBtn.disabled = !agreeCheckbox.checked;
    } else {
        checkboxRow.style.display = 'none';
        nextBtn.textContent = 'Next';
        nextBtn.disabled = false;
        if (agreeCheckbox) agreeCheckbox.checked = false;
    }

// --- Disable and gray out "Previous" on slide 2 ---
if (newIdx === 1) {
    prevBtn.disabled = true;
    prevBtn.style.opacity = "0.5";
    prevBtn.style.pointerEvents = "none";
    prevBtn.style.background = "#e0e0e0";
    prevBtn.style.color = "#888";
    prevBtn.style.border = "none";
} else {
    prevBtn.disabled = false;
    prevBtn.style.opacity = "";
    prevBtn.style.pointerEvents = "";
    prevBtn.style.background = "";
    prevBtn.style.color = "";
    prevBtn.style.border = "";
}
prevBtn.style.visibility = newIdx === 0 ? 'hidden' : 'visible';

// --- 6-digit code validation logic for first slide ---
if (newIdx === 0) {
    const codeInput = document.getElementById('user-code-input');
    const codeError = document.getElementById('code-error-msg');
    nextBtn.disabled = true;
    codeInput.addEventListener('input', function () {
        // Only allow digits
        this.value = this.value.replace(/\D/g, '').slice(0, 6);
        if (this.value.length === 6) {
            codeError.style.visibility = 'hidden';
            nextBtn.disabled = false;
        } else {
            codeError.style.visibility = this.value.length > 0 ? 'visible' : 'hidden';
            nextBtn.disabled = true;
        }
    });
    nextBtn.onclick = function () {
        if (codeInput.value.length === 6) {
            userSixDigitCode = codeInput.value;
            lastSlide = currentSlide;
            currentSlide++;
            renderCarouselSlides(currentSlide, 1);
        } else {
            codeError.style.visibility = 'visible';
        }
    };
} else {
    // Restore default next button behavior for other slides
    nextBtn.onclick = function () {
        // Prevent moving forward if code not submitted
        if (!userSixDigitCode) return;
        if (currentSlide < carouselSlides.length - 1) {
            lastSlide = currentSlide;
            currentSlide++;
            renderCarouselSlides(currentSlide, 1);
        } else if (!this.disabled) {
            // Hide carousel overlay smoothly
            const overlay = document.getElementById('carousel-overlay');
            overlay.classList.remove('open');
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.style.opacity = 0;
                showTaskCounter();
            }, 500);
        }
    };
}}

// Checkbox event: enable/disable the "Έναρξη" button
document.getElementById('carousel-agree-checkbox').addEventListener('change', function() {
    const nextBtn = document.getElementById('carousel-next');
    nextBtn.disabled = !this.checked;
});

// Navigation buttons
document.getElementById('carousel-prev').onclick = function() {
    if (currentSlide > 0) {
        lastSlide = currentSlide;
        currentSlide--;
        renderCarouselSlides(currentSlide, -1);
    }
};
document.getElementById('carousel-next').onclick = function() {
    if (currentSlide < carouselSlides.length - 1) {
        lastSlide = currentSlide;
        currentSlide++;
        renderCarouselSlides(currentSlide, 1);
    } else if (!this.disabled) {
        // Hide carousel overlay smoothly
        const overlay = document.getElementById('carousel-overlay');
        overlay.classList.remove('open');
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.style.opacity = 0;
        }, 500);
    }
};

// Show carousel after welcome screen
document.getElementById('welcome-button').addEventListener('click', function () {
    setTimeout(() => {
        const overlay = document.getElementById('carousel-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('open'), 10);
        currentSlide = 0;
        lastSlide = 0;
        renderCarouselSlides(0, 0);
    }, 550); // after welcome screen fades out
});

// Prevent closing with Escape or clicking outside
document.getElementById('carousel-overlay').addEventListener('click', function(e) {
    if (e.target === this) {
        e.stopPropagation();
    }
});
document.addEventListener('keydown', function (event) {
    if (document.getElementById('carousel-overlay').classList.contains('open') && event.key === 'Escape') {
        event.preventDefault();
    }
});

// --- TASK SYSTEM ---
const tasks = [
    {
        text: "Task 1: Navigate to any monument marker and explore all tabs.",
        completed: false,
        check: function() {
            // User must open overlay and visit all tabs
            return window._task1TabsVisited && Object.values(window._task1TabsVisited).every(v => v);
        }
    },
    {
        text: "Task 2: Open the 3D Model Tab for the Leaning Tower of Pisa, Big Ben and The Brandenburg Gate",
        completed: false,
        check: function() {
            // User must open 3D Model tab for all three monuments
            return window._task2ModelTabs && 
                window._task2ModelTabs['Leaning Tower of Pisa'] &&
                window._task2ModelTabs['Big Ben'] &&
                window._task2ModelTabs['Brandenburg Gate'];
        }
    },
    {
        text: "Task 3: Listen to the Audio Guides for The White Tower of Thessaloniki and Colosseum",
        completed: false,
        check: function() {
            // User must play audio for both monuments
            return window._task3AudioPlayed &&
                window._task3AudioPlayed['White Tower of Thessaloniki'] &&
                window._task3AudioPlayed['Colosseum'];
        }
    },
    {
        text: "Task 4: Change the map appearance from the Basemap selection dropdown menu",
        completed: false,
        check: function() {
            // Return true when the user completes Task 4
            return window._task4Completed;
        }
    }
];

// State trackers
function resetTaskTrackers() {
    window._task1TabsVisited = { info: false, desc: false, img: false, audio: false, video: false, model: false, qr: false };
    window._task2ModelTabs = { 'Leaning Tower of Pisa': false, 'Big Ben': false, 'Brandenburg Gate': false };
    window._task3AudioPlayed = { 'White Tower of Thessaloniki': false, 'Colosseum': false };
    window._task4Completed = false;
    window._task4Active = false;
}
resetTaskTrackers();

let currentTask = 0;

// Track task timing
let taskStartTimes = [];
let taskEndTimes = [];
let taskDurations = [];

function showTaskCounter() {
    const el = document.getElementById('task-counter');
    el.style.display = 'block';
    // Start time for the first task
    if (taskStartTimes.length === 0) {
        taskStartTimes[0] = Date.now();
    }
    updateTaskCounter();
}

// Track total time spent in each tab
const tabNames = ['info', 'desc', 'img', 'audio', 'video', 'model', 'qr'];
let tabTotalTimes = {};
let tabLastEnterTime = {};
let currentTab = null;

function resetTabTimers() {
    tabNames.forEach(tab => {
        tabTotalTimes[tab] = 0;
        tabLastEnterTime[tab] = null;
    });
    currentTab = null;
}
resetTabTimers();

// Track number of clicks per tab
let tabClickCounts = {};
tabNames.forEach(tab => tabClickCounts[tab] = 0);

function resetTabClickCounts() {
    tabNames.forEach(tab => tabClickCounts[tab] = 0);
}

    // Record end time and duration for the current task
    taskEndTimes[currentTask] = Date.now();
    taskDurations[currentTask] = (taskEndTimes[currentTask] - taskStartTimes[currentTask]) / 1000; // seconds

function updateTaskCounter() {
    const el = document.getElementById('task-counter');
    if (currentTask < tasks.length) {
        el.textContent = tasks[currentTask].text;
        el.style.color = '#c0392b';
        el.style.borderColor = '#c0392b';
        el.style.background = '#fff';
    } else {
        el.textContent = "All tasks completed!";
        el.style.color = '#27ae60';
        el.style.borderColor = '#27ae60';
        el.style.background = '#eafaf1';
    }
}
function completeCurrentTask() {
    const el = document.getElementById('task-counter');
    el.style.color = '#27ae60';
    el.style.borderColor = '#27ae60';
    el.style.background = '#eafaf1';

}

// --- Task 1: Track tab visits ---
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tab = this.getAttribute('data-tab');

        // --- Tab timing logic ---
        const now = Date.now();
        if (currentTab && tabLastEnterTime[currentTab] !== null) {
            tabTotalTimes[currentTab] += (now - tabLastEnterTime[currentTab]) / 1000; // seconds
        }
        tabLastEnterTime[tab] = now;
        currentTab = tab;
        
        // Increment click count
        tabClickCounts[tab] = (tabClickCounts[tab] || 0) + 1;

        // ...existing code for tasks...
        if (currentTask === 0) {
            window._task1TabsVisited[tab] = true;
            if (tasks[0].check()) {
                completeCurrentTask();
            }
        }
        if (currentTask === 1 && tab === 'model') {
            const name = window._lastMonumentNameClicked;
            if (name === 'Leaning Tower of Pisa' || name === 'Big Ben' || name === 'Brandenburg Gate') {
                window._task2ModelTabs[name] = true;
                if (tasks[1].check()) {
                    completeCurrentTask();
                }
            }
        }
    });
});

// --- Task 3: Listen to audio guides ---
document.addEventListener('play', function(e) {
    if (currentTask === 2 && e.target.tagName === 'AUDIO' && window._lastMonumentNameClicked) {
        const name = window._lastMonumentNameClicked;
        if (name === 'White Tower of Thessaloniki' || name === 'Colosseum') {
            window._task3AudioPlayed[name] = true;
            if (tasks[2].check()) {
                completeCurrentTask();
            }
        }
    }
}, true);

    // Auto-complete Info tab for Task 1
    if (currentTask === 0 && window._task1TabsVisited) {
        window._task1TabsVisited.info = true;
    }

// --- Show task counter after carousel overlay closes ---
const origCarouselNext = document.getElementById('carousel-next').onclick;
document.getElementById('carousel-next').onclick = function() {
    if (currentSlide < carouselSlides.length - 1) {
        lastSlide = currentSlide;
        currentSlide++;
        renderCarouselSlides(currentSlide, 1);
    } else if (!this.disabled) {
        // Hide carousel overlay smoothly
        const overlay = document.getElementById('carousel-overlay');
        overlay.classList.remove('open');
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.style.opacity = 0;
            showTaskCounter();
        }, 500);
    }
};

// If user skips carousel, still show tasks
if (document.getElementById('carousel-overlay').style.display === 'none') {
    setTimeout(showTaskCounter, 2000);
}

// ...existing code..
// ...existing code...
function showQuestionnaireOverlay() {
    const overlay = document.getElementById('form-redirect-overlay');
    overlay.style.display = 'flex';
    setTimeout(() => overlay.classList.add('open'), 10);

    // Disable the button until email is sent
    const btn = document.getElementById('open-form-btn');
    btn.disabled = true;
    btn.textContent = "Please Wait...";

    // Send the email
    sendResultsByEmailJS(taskDurations, function(success) {
        if (success) {
            btn.disabled = false;
            btn.textContent = "Proceed to Questionnaire";
            btn.onclick = function() {
                // Hide the overlay smoothly
                overlay.classList.remove('open');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);

                // Update the task bar message
                const el = document.getElementById('task-counter');
                el.textContent = "You have completed all tasks! Thank you for your participation. You can now explore the app freely.";
                el.style.color = '#2563eb';
                el.style.borderColor = '#2563eb';
                el.style.background = '#f0f6ff';

                // Open the questionnaire in a new tab
                window.open("https://docs.google.com/forms/d/e/1FAIpQLSeyK30cKMTxVxK4pa1yqFX0O-pN3tEJ_V8ik1CXQeRIYyA3yg/viewform", "_blank");
            };
        } else {
            btn.disabled = false;
            btn.textContent = "Please Try Again";
            btn.onclick = function() {
                showQuestionnaireOverlay(); // Retry
            };
        }
    });
}

function sendResultsByEmailJS(taskDurations, callback) {
    // Prepare CSV content
    const csvRows = [
        [
            "ID", "Task 1 Time (s)", "Task 2 Time (s)", "Task 3 Time (s)", "Task 4 Time (s)",
            ...tabNames.map(tab => `Tab ${tab} Time (s)`),
            ...tabNames.map(tab => `Tab ${tab} Clicks`)
        ],
        [
            userSixDigitCode,
            taskDurations[0] || "",
            taskDurations[1] || "",
            taskDurations[2] || "",
            taskDurations[3] || "",
            ...tabNames.map(tab => tabTotalTimes[tab]?.toFixed(2) || "0"),
            ...tabNames.map(tab => tabClickCounts[tab] || "0")
        ]
    ];
    const csvContent = csvRows.map(row => row.join(",")).join("\r\n");

    // Prepare EmailJS params
    const params = {
        subject: "User Task Times CSV",
        message: "See attached CSV for user task times.",
        csv_attachment: csvContent
    };

    // Send email using EmailJS
    emailjs.send("UserTaskTimes", "template_9x49afd", params)
        .then(function(response) {
            if (callback) callback(true);
        }, function(error) {
            if (callback) callback(false);
        });
}

// 5. Call showQuestionnaireOverlay or sendResultsByEmailJS when all tasks are complete
function completeCurrentTask() {
    const el = document.getElementById('task-counter');
    el.style.color = '#27ae60';
    el.style.borderColor = '#27ae60';
    el.style.background = '#eafaf1';

    // Play completion sound
    const audio = new Audio('sounds/Complete.mp3');
    audio.play();

    // Record end time and duration for the current task
    taskEndTimes[currentTask] = Date.now();
    taskDurations[currentTask] = (taskEndTimes[currentTask] - taskStartTimes[currentTask]) / 1000; // seconds

    // Move to next task or finish
    currentTask++;
    if (currentTask < tasks.length) {
        setTimeout(() => {
            taskStartTimes[currentTask] = Date.now();
            updateTaskCounter();

            // 🟢 Activate Task 4 tracking only when Task 4 starts
            window._task4Active = (currentTask === 3);
        }, 1500);
    } else {
        setTimeout(() => {
            updateTaskCounter();
            showQuestionnaireOverlay();
        }, 1500);
    }
}
// 🟢 GEOCODER
        var osmGeocoder = new L.Control.Geocoder({
            collapsed: true,
            position: 'topleft',
            text: 'Search',
            title: 'Testing'
        }).addTo(map);
        document.getElementsByClassName('leaflet-control-geocoder-icon')[0]
        .className += ' fa fa-search';
        document.getElementsByClassName('leaflet-control-geocoder-icon')[0]
        .title += 'Search for a place';
        setBounds();
        </script>
    </body>
</html>
